#!/usr/bin/env ruby -w

begin
  require 'rubygems'
rescue LoadError
end
require 'yaml'
require 'optparse'

opts = OptionParser.new
opts.banner = <<BANNER
Usage: #{opts.program_name} PATH_TO_CONFIG

Start a tkellem instance using the specified configuration file (or ~/.tkellem/config.yml if none given)
BANNER

opts.on_tail("-h", "--help") { puts opts; exit }

rest = opts.parse(ARGV)
config_filename = rest.first || File.expand_path(ENV["HOME"]+'/.tkellem/config.yml')

config = YAML.load_file(config_filename)

$LOAD_PATH.push(File.expand_path(File.dirname(__FILE__)+'/../lib'))
require 'tkellem'

EM.run do
  EM.start_server(config['listen'] || '0.0.0.0', config['port'] || 10001,
                  BouncerConnection, config)

  config['connections'].each do |name, conn_config|
    listener = EM.connect(conn_config['host'], conn_config['port'],
                          Listener, name, conn_config)
    BouncerConnection.add_listener(listener)

    conn_config['clients'].each do |client|
      listener.bouncers[client['name']] = Bouncer.new(client['name'])
    end
  end
end
