#!/usr/bin/env ruby

begin
  require 'rubygems'
rescue LoadError
end
require 'yaml'
require 'optparse'

opts = OptionParser.new
opts.banner = <<BANNER
Usage: #{opts.program_name} PATH_TO_CONFIG

Start a tkellem instance using the specified configuration file (or ~/.tkellem/config.yml if none given)
BANNER

opts.on_tail("-h", "--help") { puts opts; exit }

rest = opts.parse(ARGV)
config_filename = rest.first || File.expand_path(ENV["HOME"]+'/.tkellem/config.yml')

config = YAML.load_file(config_filename)

$LOAD_PATH.push(File.expand_path(File.dirname(__FILE__)+'/../lib'))
require 'tkellem'

EM.run do
  bouncer =
    Tkellem::Bouncer.new(config['listen'] || '0.0.0.0',
                         config['port'] || 10001,
                         config['ssl'])

  config['connections'].each do |name, conn|
    server = bouncer.add_irc_server(name,
                                    conn['host'], conn['port'], conn['ssl'],
                                    conn['nick'])

    (conn['rooms'] || []).each { |room| server.join_room(room['name']) }
    conn['clients'].each { |client| server.add_client(client['name']) }
  end
end
